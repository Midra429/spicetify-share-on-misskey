(async()=>{for(;!Spicetify.React||!Spicetify.ReactDOM;)await new Promise(e=>setTimeout(e,10));var a,i,n,o,l,r,c,e,t,s,d,p,y,u,f,m,h,g,w,S,v,b,k,x,C;i=Object.create,n=Object.defineProperty,o=Object.getOwnPropertyDescriptor,l=Object.getOwnPropertyNames,r=Object.getPrototypeOf,c=Object.prototype.hasOwnProperty,s=(e=(e,t)=>function(){return t||(0,e[l(e)[0]])((t={exports:{}}).exports,t),t.exports})({"external-global-plugin:react-dom"(e,t){t.exports=Spicetify.ReactDOM}}),d=(t=(e,t,s)=>(s=null!=e?i(r(e)):{},((t,s,i,a)=>{if(s&&"object"==typeof s||"function"==typeof s)for(let e of l(s))c.call(t,e)||e===i||n(t,e,{get:()=>s[e],enumerable:!(a=o(s,e))||a.enumerable});return t})(!t&&e&&e.__esModule?s:n(s,"default",{value:e,enumerable:!0}),e)))(e({"external-global-plugin:react"(e,t){t.exports=Spicetify.React}})()),p=t(s()),y=class{constructor(e,t,s={}){this.name=e,this.settingsId=t,this.initialSettingsFields=s,this.settingsFields=this.initialSettingsFields,this.setRerender=null,this.pushSettings=async()=>{for(Object.entries(this.settingsFields).forEach(([e,t])=>{"button"!==t.type&&void 0===this.getFieldValue(e)&&this.setFieldValue(e,t.defaultValue)});!Spicetify?.Platform?.History?.listen;)await new Promise(e=>setTimeout(e,100));this.stopHistoryListener&&this.stopHistoryListener(),this.stopHistoryListener=Spicetify.Platform.History.listen(e=>{"/preferences"===e.pathname&&this.render()}),"/preferences"===Spicetify.Platform.History.location.pathname&&await this.render()},this.rerender=()=>{this.setRerender&&this.setRerender(Math.random())},this.render=async()=>{for(;!document.getElementById("desktop.settings.selectLanguage");){if("/preferences"!==Spicetify.Platform.History.location.pathname)return;await new Promise(e=>setTimeout(e,100))}var e=document.querySelector(".main-view-container__scroll-node-child main div");if(!e)return console.error("[spcr-settings] settings container not found");let t=Array.from(e.children).find(e=>e.id===this.settingsId);t?console.log(t):((t=document.createElement("div")).id=this.settingsId,e.appendChild(t)),p.default.render(d.default.createElement(this.FieldsContainer,null),t)},this.addButton=(e,t,s,i,a)=>{this.settingsFields[e]={type:"button",description:t,value:s,events:{onClick:i,...a}}},this.addInput=(e,t,s,i,a,n)=>{this.settingsFields[e]={type:"input",description:t,defaultValue:s,inputType:a,events:{onChange:i,...n}}},this.addHidden=(e,t)=>{this.settingsFields[e]={type:"hidden",defaultValue:t}},this.addToggle=(e,t,s,i,a)=>{this.settingsFields[e]={type:"toggle",description:t,defaultValue:s,events:{onChange:i,...a}}},this.addDropDown=(e,t,s,i,a,n)=>{this.settingsFields[e]={type:"dropdown",description:t,defaultValue:s[i],options:s,events:{onSelect:a,...n}}},this.getFieldValue=e=>JSON.parse(Spicetify.LocalStorage.get(this.settingsId+"."+e)||"{}")?.value,this.setFieldValue=(e,t)=>{Spicetify.LocalStorage.set(this.settingsId+"."+e,JSON.stringify({value:t}))},this.FieldsContainer=()=>{var[e,t]=(0,d.useState)(0);return this.setRerender=t,d.default.createElement("div",{className:"x-settings-section",key:e},d.default.createElement("h2",{className:"TypeElement-cello-textBase-type"},this.name),Object.entries(this.settingsFields).map(([e,t])=>d.default.createElement(this.Field,{nameId:e,field:t})))},this.Field=s=>{var e=this.settingsId+"."+s.nameId;let t;if(t="button"===s.field.type?s.field.value:this.getFieldValue(s.nameId),"hidden"===s.field.type)return d.default.createElement(d.default.Fragment,null);let[i,a]=(0,d.useState)(t),n=e=>{void 0!==e&&(a(e),this.setFieldValue(s.nameId,e))};return d.default.createElement("div",{className:"x-settings-row"},d.default.createElement("div",{className:"x-settings-firstColumn"},d.default.createElement("label",{className:"TypeElement-viola-textSubdued-type",htmlFor:e},s.field.description||"")),d.default.createElement("div",{className:"x-settings-secondColumn"},"input"===s.field.type?d.default.createElement("input",{className:"x-settings-input",id:e,dir:"ltr",value:i,type:s.field.inputType||"text",...s.field.events,onChange:e=>{n(e.currentTarget.value);var t=s.field.events?.onChange;t&&t(e)}}):"button"===s.field.type?d.default.createElement("span",null,d.default.createElement("button",{id:e,className:"Button-sc-y0gtbx-0 Button-small-buttonSecondary-useBrowserDefaultFocusStyle x-settings-button",...s.field.events,onClick:e=>{n();var t=s.field.events?.onClick;t&&t(e)},type:"button"},i)):"toggle"===s.field.type?d.default.createElement("label",{className:"x-settings-secondColumn x-toggle-wrapper"},d.default.createElement("input",{id:e,className:"x-toggle-input",type:"checkbox",checked:i,...s.field.events,onClick:e=>{n(e.currentTarget.checked);var t=s.field.events?.onClick;t&&t(e)}}),d.default.createElement("span",{className:"x-toggle-indicatorWrapper"},d.default.createElement("span",{className:"x-toggle-indicator"}))):"dropdown"===s.field.type?d.default.createElement("select",{className:"main-dropDown-dropDown",id:e,...s.field.events,onChange:e=>{n(s.field.options[e.currentTarget.selectedIndex]);var t=s.field.events?.onChange;t&&t(e)}},s.field.options.map((e,t)=>d.default.createElement("option",{selected:e===i,value:t+1},e))):d.default.createElement(d.default.Fragment,null)))}}},u="Button-sc-y0gtbx-0 Button-buttonSecondary-small-useBrowserDefaultFocusStyle encore-text-body-small-bold x-settings-button",f=e=>!!e&&/^https?:\/\//.test(e)&&URL.canParse(e),h={misskeyHost:"misskey.io",misskeyToken:"",useMisskeyWeb:!(m=[["public","パブリック"],["home","ホーム"],["followers","フォロワー"]]),misskeyVisibility:1,showContextMenuButton:!0,showControlPanelButton:!0},g='<svg class="Svg-img-icon-small" fill="currentColor" version="1.1" viewBox="0 0 135.47 135.47" xmlns="http://www.w3.org/2000/svg"><g transform="translate(-38.1 -100.7)"><path d="m54.63 120.96c-1.9779 0-3.8618 0.32979-5.6513 0.98909-3.2023 1.1302-5.8396 3.1553-7.9117 6.0751-1.9779 2.8256-2.9667 5.9807-2.9667 9.4656v61.88c0 4.5209 1.601 8.4294 4.8033 11.726 3.2965 3.2023 7.2055 4.8038 11.726 4.8038 4.6151 0 8.5236-1.6015 11.726-4.8038 3.2965-3.2965 4.9449-7.205 4.9449-11.726v-11.253c0.03556-2.4371 2.546-1.7977 3.8148 0 2.3763 4.1153 7.4142 7.6497 13.28 7.6295 5.8656-0.0202 10.737-2.9202 13.28-7.6295 0.96304-1.1358 3.6774-3.071 3.9558 0v11.253c0 4.5209 1.601 8.4294 4.8033 11.726 3.2965 3.2023 7.2055 4.8038 11.726 4.8038 4.6151 0 8.5236-1.6015 11.726-4.8038 3.2965-3.2965 4.9449-7.205 4.9449-11.726v-61.88c0-3.4849-1.0357-6.64-3.1078-9.4656-1.9779-2.9198-4.5683-4.9448-7.7706-6.0751-1.8837-0.6593-3.7676-0.98909-5.6513-0.98909-5.086 0-9.3712 1.9782-12.856 5.934l-16.775 19.632c-0.37674 0.28256-1.6248 2.4428-4.2757 2.4428-2.6509 0-3.7574-2.1602-4.1341-2.4428l-16.916-19.632c-3.3907-3.9558-7.6289-5.934-12.715-5.934zm104.53 0c-3.9558 0-7.3464 1.4129-10.172 4.2385-2.7314 2.7314-4.0969 6.0751-4.0969 10.031 0 3.9558 1.3655 7.3464 4.0969 10.172 2.8256 2.7314 6.2162 4.0974 10.172 4.0974 3.9558 0 7.3464-1.366 10.172-4.0974 2.8256-2.8256 4.2385-6.2162 4.2385-10.172 0-3.9558-1.4129-7.2995-4.2385-10.031-2.8256-2.8256-6.2162-4.2385-10.172-4.2385zm0.14107 31.364c-3.9558 0-7.3464 1.4129-10.172 4.2385s-4.238 6.2162-4.238 10.172v34.896c0 3.9558 1.4124 7.3464 4.238 10.172 2.8256 2.7314 6.2162 4.0974 10.172 4.0974s7.2995-1.366 10.031-4.0974c2.8256-2.8256 4.2385-6.2162 4.2385-10.172v-34.896c0-3.9558-1.4129-7.3464-4.2385-10.172-2.7314-2.8256-6.0751-4.2385-10.031-4.2385z"/></g></svg>',w=class{host;token;baseUrl;constructor(e,t){this.host=e,this.token=t,this.baseUrl=f(e)?new URL("/api",e).href:`https://${e}/api`}async createNote(e){if(e.text)try{var t=await fetch(this.baseUrl+"/notes/create",{method:"POST",headers:{Authorization:"Bearer "+this.token,"Content-Type":"application/json"},body:JSON.stringify(e)}),s=await t.json();if(t.ok)return s;throw new Error(s.error?.message||t.statusText)}catch(e){Spicetify.showNotification("[Share on Misskey] "+e.message,!0)}}},S=null,v=()=>{var e=a.getFieldValue("misskeyHost"),t=a.getFieldValue("misskeyToken");return e&&t?e===S?.host&&t===S?.token||(S=new w(e,t)):S=null,S},b={track:async e=>Spicetify.CosmosAsync.get("https://api.spotify.com/v1/tracks/"+e.id),album:async e=>Spicetify.CosmosAsync.get("https://api.spotify.com/v1/albums/"+e.id),artist:async e=>Spicetify.CosmosAsync.get("https://api.spotify.com/v1/artists/"+e.id),show:async e=>Spicetify.CosmosAsync.get("https://api.spotify.com/v1/shows/"+e.id),episode:async e=>Spicetify.CosmosAsync.get("https://api.spotify.com/v1/episodes/"+e.id),playlist:async e=>Spicetify.CosmosAsync.get("https://api.spotify.com/v1/playlists/"+e.id)},k=async(t,s={})=>{if(t?.id){s=s.hashtag;let e="";try{switch(t.type){case Spicetify.URI.Type.TRACK:var i=await b.track(t);e+=i.name,i.artists.length&&(e=(e+=" - ")+i.artists.map(e=>e.name).join(", "));break;case Spicetify.URI.Type.ALBUM:var a=await b.album(t);e+=a.name;break;case Spicetify.URI.Type.ARTIST:var n=await b.artist(t);e+=n.name;break;case Spicetify.URI.Type.SHOW:var o=await b.show(t);e+=o.name;break;case Spicetify.URI.Type.EPISODE:var l=await b.episode(t);e=(e=e+l.name+" - ")+l.show.name;break;case Spicetify.URI.Type.PLAYLIST:case Spicetify.URI.Type.PLAYLIST_V2:var r=await b.playlist(t);e+=r.name}if(!e)return;s&&(e+=" #"+s),e=(e+="\n")+t.toURL()}catch(e){Spicetify.showNotification("[Share on Misskey] "+e.message,!0)}return e.trim()}},x=async(e,s={})=>{e=await k(e,s);if(e){let t=a.getFieldValue("misskeyVisibility");var i,s=m.find(([,e])=>e===t)?.[0];a.getFieldValue("useMisskeyWeb")?(i=a.getFieldValue("misskeyHost"))?((i=f(i)?new URL("/share",i):new URL(`https://${i}/share`)).searchParams.set("text",e),i.searchParams.set("visibility",s??"public"),window.open(i)):Spicetify.showNotification("[Share on Misskey] サーバーのホストを設定してください",!0):(i=v())?await i.createNote({text:e,visibility:s})&&Spicetify.showNotification("[Share on Misskey] 投稿しました"):Spicetify.showNotification("[Share on Misskey] サーバーのホストとアクセストークンを設定してください",!0)}else Spicetify.showNotification("[Share on Misskey] この形式には非対応です",!0)},C=async()=>{for(;!Spicetify;)await new Promise(e=>setTimeout(e,100));(a=new y("Share on Misskey","share-on-misskey")).addInput("misskeyHost","サーバーのホスト",h.misskeyHost),a.addInput("misskeyToken","アクセストークン",h.misskeyToken),a.addButton("openSettingsApiPage","　設定したサーバーの「設定 > API」を開く","「設定 > API」を開く",()=>{var e=a.getFieldValue("misskeyHost");e?window.open(f(e)?new URL("/settings/api",e):`https://${e}/settings/api`):Spicetify.showNotification("サーバーのホストを入力してください",!0)},{className:u}),a.addToggle("useMisskeyWeb","Misskey Webで投稿する（アクセストークン不要）",h.useMisskeyWeb),a.addDropDown("misskeyVisibility","公開範囲",m.map(([,e])=>e),h.misskeyVisibility),a.addToggle("showContextMenuButton","コンテキストメニューに「Misskeyでシェア」を表示",h.showContextMenuButton),a.addToggle("showControlPanelButton","コントロールパネルに「#NowPlaying」を表示",h.showControlPanelButton),await a.pushSettings(),a.getFieldValue("showContextMenuButton")&&new Spicetify.ContextMenu.Item("Misskeyでシェア",async e=>{2<=e.length?Spicetify.showNotification("[Share on Misskey] 複数の項目が選択されています",!0):(e=Spicetify.URI.from(e[0]),await x(e))},void 0,g).register(),a.getFieldValue("showControlPanelButton")&&new Spicetify.Playbar.Button("#NowPlaying",g,async()=>{var e=Spicetify.URI.from(Spicetify.Player.data?.item.uri);await x(e,{hashtag:"NowPlaying"})}).register()},(async()=>{await C()})()})();